<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout | Christophoros Cioccolato</title>
    <meta name="description" content="Completa tu compra de bombones Christophoros. Ingresa tus datos de envío y pago.">
    <meta name="robots" content="noindex, nofollow"> 
    <link rel="icon" type="image/png" href="images/favicon.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js" onerror="console.error('CRITICAL ERROR: Supabase UMD CDN script failed to load. Check network connection and CDN URL.')"></script>

    <script>
        // Configuración de Tailwind (se ejecuta después de que Tailwind CSS se carga)
        if (typeof tailwind !== 'undefined') {
            tailwind.config = {
                theme: {
                    extend: {
                        colors: {
                            'brand-navy-primary': '#0D1B2A',
                            'brand-navy-text': '#1B263B',
                            'brand-blue': '#0f2a66',
                            'brand-off-white': '#FDFBF9',
                            'brand-gold-accent': '#BFA181',
                        },
                        fontFamily: {
                            'serif': ['Playfair Display', 'serif'],
                            'sans': ['Lato', 'sans-serif'],
                        }
                    }
                }
            };
        } else {
            console.warn("checkout.html (head): Tailwind CSS object not found when trying to set config.")
        }
    </script>
    
    <style>
        html { scroll-behavior: smooth; }
        body {
            font-family: 'Lato', sans-serif;
            color: #1B263B; /* brand-navy-text */
            background-color: #FDFBF9; /* brand-off-white */
        }
        h1, h2, h3, h4, h5, h6 {
            font-family: 'Playfair Display', serif;
            color: #1B263B; /* brand-navy-text */
        }
        .btn-action {
             background-color: #0f2a66; /* brand-blue */
             color: white;
             transition: background-color 0.3s ease, transform 0.2s ease;
             cursor: pointer;
        }
        .btn-action:hover {
             background-color: #0D1B2A; /* brand-navy-primary */
             transform: scale(1.03);
        }
        .btn-action:disabled {
            background-color: #A0AEC0; /* gray-400 */
            cursor: not-allowed;
        }
        .btn-secondary-outline {
            background-color: transparent;
            color: #0f2a66; /* brand-blue */
            border: 1px solid #0f2a66; /* brand-blue */
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .btn-secondary-outline:hover {
            background-color: #0f2a66; /* brand-blue */
            color: white;
        }
        header { 
            background-color: rgba(253, 251, 249, 0.95); /* brand-off-white con transparencia */
            backdrop-filter: blur(8px);
        }
        footer { 
            background-color: #0D1B2A; /* brand-navy-primary */
            color: #FDFBF9; /* brand-off-white */
        }
        footer a {
            color: #BFA181; /* brand-gold-accent */
        }
        footer a:hover {
            color: #FDFBF9; /* brand-off-white */
        }
        footer h4, footer h5 {
             color: #FDFBF9; /* brand-off-white */
        }
         footer .footer-text-secondary {
             color: #D1B490; /* Un tono más claro de brand-gold-accent */
         }
        #mobile-menu-checkout-page { 
            transition: transform 0.3s ease-in-out;
        }
        .form-section {
            background-color: white;
            padding: 1.5rem; 
            border-radius: 0.5rem; 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); 
            margin-bottom: 2rem; 
        }
        .form-input, .form-select {
            width: 100%;
            padding: 0.75rem 1rem; 
            border: 1px solid #D1D5DB; 
            border-radius: 0.375rem; 
            transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            background-color: white;
        }
        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: #0f2a66; 
            box-shadow: 0 0 0 2px rgba(15, 42, 102, 0.3); 
        }
        .form-label {
            display: block;
            margin-bottom: 0.5rem; 
            font-weight: 600; 
            color: #1B263B; 
        }
        .radio-label {
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            border: 1px solid #D1D5DB;
            border-radius: 0.375rem;
            cursor: pointer;
            transition: border-color 0.2s ease, background-color 0.2s ease;
        }
        .radio-label input[type="radio"] {
            margin-right: 0.5rem;
        }
        .radio-label:hover, input[type="radio"]:checked + .radio-label-span { 
            border-color: #0f2a66;
        }
        input[type="radio"]:checked ~ .radio-label-span-container { /* Estilo para el contenedor del radio seleccionado */
             border-color: #0f2a66;
             background-color: #EBF8FF;
        }
        .payment-method-details {
            background-color: #f9fafb; 
            border: 1px solid #e5e7eb; 
            border-radius: 0.375rem; 
            padding: 1rem;
            margin-top: 0.5rem;
        }
        .form-message {
            margin-top: 1rem;
            padding: 0.75rem 1rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            text-align: center;
        }
        .form-message.success {
            background-color: #c6f6d5; 
            color: #2f855a; 
            border: 1px solid #9ae6b4; 
        }
        .form-message.error {
            background-color: #fed7d7; 
            color: #c53030; 
            border: 1px solid #fbb6ce; 
        }
    </style>
</head>
<body class="font-sans">

    <header class="shadow-md sticky top-0 z-50">
        <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
            <a href="index.html#inicio" class="flex items-center text-3xl font-serif font-bold text-brand-navy-text">
                <img src="images/favicon.png" alt="Logo Christophoros" class="h-8 w-8 mr-3 rounded-full">
                <span>Christophoros</span>
            </a>
            <div class="hidden md:flex space-x-8 items-center">
                <a href="index.html#inicio" class="text-brand-navy-text hover:text-brand-blue transition duration-300">Inicio</a>
                <a href="index.html#sabores" class="text-brand-navy-text hover:text-brand-blue transition duration-300">Sabores</a>
                <a href="index.html#formatos" class="text-brand-navy-text hover:text-brand-blue transition duration-300">Formatos</a>
                <a href="index.html#nosotros" class="text-brand-navy-text hover:text-brand-blue transition duration-300">Nuestra Travesía</a>
                <a href="index.html#contacto" class="text-brand-navy-text hover:text-brand-blue transition duration-300">Contacto</a>
                <a href="carrito.html" class="relative" id="cart-icon-link">
                     <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-brand-navy-text hover:text-brand-blue transition duration-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
                    </svg>
                    <span id="cart-count-checkout" class="absolute -top-2 -right-2 bg-brand-blue text-white text-xs rounded-full h-5 w-5 flex items-center justify-center">0</span>
                </a>
            </div>
            <div class="md:hidden">
                <button id="mobile-menu-button-checkout" class="text-brand-navy-text focus:outline-none" aria-expanded="false">
                    <svg id="menu-icon-open-checkout" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7" />
                    </svg>
                     <svg id="menu-icon-close-checkout" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
        </nav>
        <div id="mobile-menu-checkout-page" class="md:hidden absolute top-full left-0 w-full bg-brand-off-white shadow-lg py-4 transform -translate-y-full -z-10">
             <a href="index.html#inicio" class="block px-6 py-2 text-brand-navy-text hover:bg-brand-navy-text/10">Inicio</a>
             <a href="index.html#sabores" class="block px-6 py-2 text-brand-navy-text hover:bg-brand-navy-text/10">Sabores</a>
             <a href="index.html#formatos" class="block px-6 py-2 text-brand-navy-text hover:bg-brand-navy-text/10">Formatos</a>
             <a href="index.html#nosotros" class="block px-6 py-2 text-brand-navy-text hover:bg-brand-navy-text/10">Nuestra Travesía</a>
             <a href="index.html#contacto" class="block px-6 py-2 text-brand-navy-text hover:bg-brand-navy-text/10">Contacto</a>
        </div>
    </header>

    <main class="py-12 md:py-20">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8">
            <h1 class="text-3xl md:text-4xl font-serif font-bold text-brand-navy-text mb-10 text-center">Finalizar Compra</h1>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="lg:col-span-2">
                    <form id="checkout-form" class="space-y-8">
                        <div class="form-section">
                            <h2 class="text-2xl font-semibold text-brand-navy-text mb-6">1. Información de Contacto</h2>
                            <div class="space-y-4">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label for="checkout-nombre" class="form-label">Nombre <span class="text-red-500">*</span></label>
                                        <input type="text" id="checkout-nombre" name="checkout-nombre" class="form-input" required>
                                    </div>
                                    <div>
                                        <label for="checkout-apellido" class="form-label">Apellidos <span class="text-red-500">*</span></label>
                                        <input type="text" id="checkout-apellido" name="checkout-apellido" class="form-input" required>
                                    </div>
                                </div>
                                <div>
                                    <label for="checkout-email" class="form-label">Correo Electrónico <span class="text-red-500">*</span></label>
                                    <input type="email" id="checkout-email" name="checkout-email" class="form-input" placeholder="tu@email.com" required>
                                </div>
                                <div>
                                    <label for="checkout-telefono-contacto" class="form-label">Teléfono <span class="text-red-500">*</span></label>
                                    <input type="tel" id="checkout-telefono-contacto" name="checkout-telefono-contacto" class="form-input" placeholder="+56912345678" required>
                                </div>
                            </div>
                        </div>

                        <div class="form-section">
                            <h2 class="text-2xl font-semibold text-brand-navy-text mb-4">2. Datos para Emisión de Boleta</h2>
                            <p class="text-sm text-brand-navy-text/70 mb-4">Emitimos únicamente boleta electrónica. Los siguientes campos son obligatorios.</p>
                            <div class="space-y-4">
                                <div>
                                    <label for="boleta-nombre" class="form-label">Nombre Completo (Titular Boleta) <span class="text-red-500">*</span></label>
                                    <input type="text" id="boleta-nombre" name="boleta-nombre" class="form-input" required>
                                </div>
                                <div>
                                    <label for="boleta-rut" class="form-label">RUT (Titular Boleta, Ej: 12345678-9) <span class="text-red-500">*</span></label>
                                    <input type="text" id="boleta-rut" name="boleta-rut" class="form-input" placeholder="12345678-9" required>
                                </div>
                            </div>
                        </div>

                        <div class="form-section">
                            <h2 class="text-2xl font-semibold text-brand-navy-text mb-6">3. Tipo de Entrega</h2>
                            <div class="space-y-3">
                                <div class="radio-label-span-container border border-gray-300 rounded-md">
                                    <label class="radio-label">
                                        <input type="radio" name="tipo-entrega" value="domicilio" checked onchange="toggleEnvioInfo(true)">
                                        <span class="radio-label-span">Envío a Domicilio</span>
                                    </label>
                                </div>
                                <div class="radio-label-span-container border border-gray-300 rounded-md">
                                    <label class="radio-label">
                                        <input type="radio" name="tipo-entrega" value="tienda" onchange="toggleEnvioInfo(false)">
                                         <span class="radio-label-span">Retiro en Tienda (Temuco Centro, se coordina por WhatsApp)</span>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <div id="info-envio-section" class="form-section">
                            <h2 class="text-2xl font-semibold text-brand-navy-text mb-4">4. Información de Envío</h2>
                            <p class="text-sm text-brand-navy-text/70 mb-4">El envío es siempre por pagar en destino.</p>
                            <div class="space-y-4">
                                <div>
                                    <label for="envio-nombre-recibe" class="form-label">Nombre Completo de Quien Recibe <span class="text-red-500">*</span></label>
                                    <input type="text" id="envio-nombre-recibe" name="envio-nombre-recibe" class="form-input">
                                </div>
                                <div>
                                    <label for="envio-rut-recibe" class="form-label">RUT de Quien Recibe (Ej: 12345678-9) <span class="text-red-500">*</span></label>
                                    <input type="text" id="envio-rut-recibe" name="envio-rut-recibe" class="form-input" placeholder="12345678-9">
                                </div>
                                <div>
                                    <label for="envio-telefono-recibe" class="form-label">Teléfono de Quien Recibe <span class="text-red-500">*</span></label>
                                    <input type="tel" id="envio-telefono-recibe" name="envio-telefono-recibe" class="form-input" placeholder="+569...">
                                </div>
                                <div>
                                    <label for="envio-direccion" class="form-label">Dirección de Envío (Calle y Número) <span class="text-red-500">*</span></label>
                                    <input type="text" id="envio-direccion" name="envio-direccion" class="form-input">
                                </div>
                                <div>
                                    <label for="envio-depto" class="form-label">Oficina / Depto / Casa (Opcional)</label>
                                    <input type="text" id="envio-depto" name="envio-depto" class="form-input">
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label for="envio-region" class="form-label">Región <span class="text-red-500">*</span></label>
                                        <select id="envio-region" name="envio-region" class="form-select">
                                            <option value="">Seleccione Región</option>
                                            <option value="Araucanía">Araucanía</option>
                                            <option value="Metropolitana">Metropolitana de Santiago</option>
                                            <option value="Valparaíso">Valparaíso</option>
                                            </select>
                                    </div>
                                    <div>
                                        <label for="envio-comuna" class="form-label">Comuna <span class="text-red-500">*</span></label>
                                        <input type="text" id="envio-comuna" name="envio-comuna" class="form-input">
                                    </div>
                                </div>
                                <div>
                                    <label for="envio-instrucciones" class="form-label">Instrucciones Adicionales (Opcional)</label>
                                    <textarea id="envio-instrucciones" name="envio-instrucciones" rows="3" class="form-input"></textarea>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-section">
                            <h2 class="text-2xl font-semibold text-brand-navy-text mb-6">5. Cupón de Descuento</h2>
                            <div class="flex items-end space-x-3">
                                <div class="flex-grow">
                                    <label for="cupon" class="form-label">Ingresa tu cupón</label>
                                    <input type="text" id="cupon" name="cupon" class="form-input">
                                </div>
                                <button type="button" id="aplicar-cupon-btn" class="btn-secondary-outline py-3 px-6 rounded-md h-12">Aplicar Cupón</button>
                            </div>
                            <div id="cupon-message" class="text-sm mt-2"></div>
                        </div>

                        <div class="form-section">
                            <h2 class="text-2xl font-semibold text-brand-navy-text mb-6">6. Método de Pago</h2>
                            <div class="space-y-3">
                                <div class="radio-label-span-container border border-gray-300 rounded-md">
                                    <label class="radio-label">
                                        <input type="radio" name="metodo-pago" value="transferencia" checked>
                                        <span class="radio-label-span">Transferencia Bancaria Directa</span>
                                    </label>
                                </div>
                                <div class="payment-method-details text-sm text-brand-navy-text/80">
                                    <p><strong>Banco:</strong> Banco Estado</p>
                                    <p><strong>Tipo de Cuenta:</strong> Cuenta Corriente</p>
                                    <p><strong>Número de Cuenta:</strong> 1234567890</p>
                                    <p><strong>RUT:</strong> 76.XXX.XXX-K</p>
                                    <p><strong>Nombre Titular:</strong> Christophoros Chocolates SpA</p>
                                    <p><strong>Email para comprobante:</strong> pagos@christophoroscioccolato.cl</p>
                                    <p class="mt-2">Por favor, incluye el número de pedido en el asunto de la transferencia.</p>
                                </div>
                                <div class="radio-label-span-container border border-gray-300 rounded-md">
                                    <label class="radio-label">
                                        <input type="radio" name="metodo-pago" value="mercadopago">
                                        <span class="radio-label-span">Mercado Pago <img src="images/mercado-pago-logo.png" alt="Mercado Pago" class="h-5 inline-block ml-2"></span>
                                    </label>
                                </div>
                                <p class="text-sm text-brand-navy-text/70 mt-1">Serás redirigido a Mercado Pago para completar tu compra de forma segura.</p>
                            </div>
                        </div>

                        <div class="mt-6">
                            <label class="flex items-center">
                                <input type="checkbox" id="terminos" name="terminos" class="mr-2 h-4 w-4 text-brand-blue focus:ring-brand-blue border-gray-300 rounded" required>
                                <span class="text-sm text-brand-navy-text/90">He leído y acepto los <a href="#" class="text-brand-blue hover:underline">Términos y Condiciones</a> y la <a href="#" class="text-brand-blue hover:underline">Política de Privacidad</a>. <span class="text-red-500">*</span></span>
                            </label>
                        </div>
                        <div id="form-checkout-response-message" class="form-message mt-4"></div>


                        <div class="mt-8 text-right">
                            <button type="submit" id="finalizar-compra-btn" class="btn-action text-lg font-semibold py-3 px-10 rounded-md shadow-lg">
                                Finalizar Compra y Realizar Pedido
                            </button>
                        </div>
                    </form>
                </div>

                <div class="lg:col-span-1">
                    <div class="form-section sticky top-28"> 
                        <h2 class="text-2xl font-semibold text-brand-navy-text border-b border-gray-200 pb-4 mb-4">Resumen del Pedido</h2>
                        <div id="order-summary-items" class="space-y-3 mb-4 max-h-60 overflow-y-auto">
                            <p class="text-sm text-brand-navy-text/70">Cargando resumen...</p>
                        </div>
                        <div class="space-y-2 border-t border-gray-200 pt-4">
                            <div class="flex justify-between text-brand-navy-text/80">
                                <span>Subtotal:</span>
                                <span id="summary-subtotal">$0</span>
                            </div>
                             <div class="flex justify-between text-brand-navy-text/80">
                                <span>Descuento Cupón:</span>
                                <span id="summary-discount">-$0</span>
                            </div>
                            <div class="flex justify-between text-brand-navy-text/80">
                                <span>Envío:</span>
                                <span id="summary-shipping">Por Pagar en Destino</span>
                            </div>
                            <div class="flex justify-between text-xl font-bold text-brand-navy-text mt-2">
                                <span>TOTAL:</span>
                                <span id="summary-total">$0</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer class="py-12 mt-16 md:mt-24">
        <div class="container mx-auto px-6 text-center">
            <p class="text-sm footer-text-secondary">&copy; 2024 Christophoros Cioccolato. Todos los derechos reservados.</p>
        </div>
    </footer>

    <script>
        // Variables globales para el script de la página
        let currentDiscountAmount = 0;
        const formResponseMessageCheckout = document.getElementById('form-checkout-response-message');
        const submitButtonGlobal = document.getElementById('finalizar-compra-btn');


        // Lógica para el menú móvil
        const mobileMenuButtonCheckout = document.getElementById('mobile-menu-button-checkout');
        const mobileMenuCheckoutPage = document.getElementById('mobile-menu-checkout-page');
        const menuIconOpenCheckout = document.getElementById('menu-icon-open-checkout');
        const menuIconCloseCheckout = document.getElementById('menu-icon-close-checkout');

        if (mobileMenuButtonCheckout) {
            mobileMenuButtonCheckout.addEventListener('click', () => {
                const isExpanded = mobileMenuButtonCheckout.getAttribute('aria-expanded') === 'true';
                mobileMenuButtonCheckout.setAttribute('aria-expanded', !isExpanded);
                mobileMenuCheckoutPage.classList.toggle('-translate-y-full'); 
                mobileMenuCheckoutPage.classList.toggle('z-10'); 
                mobileMenuCheckoutPage.classList.toggle('-z-10'); 
                if (menuIconOpenCheckout) menuIconOpenCheckout.classList.toggle('hidden');
                if (menuIconCloseCheckout) menuIconCloseCheckout.classList.toggle('hidden');
            });
            if (mobileMenuCheckoutPage) { 
                mobileMenuCheckoutPage.querySelectorAll('a').forEach(link => {
                    link.addEventListener('click', () => {
                        mobileMenuButtonCheckout.setAttribute('aria-expanded', 'false');
                        mobileMenuCheckoutPage.classList.add('-translate-y-full');
                        mobileMenuCheckoutPage.classList.add('-z-10');
                        mobileMenuCheckoutPage.classList.remove('z-10');
                        if (menuIconOpenCheckout) menuIconOpenCheckout.classList.remove('hidden');
                        if (menuIconCloseCheckout) menuIconCloseCheckout.classList.add('hidden');
                    });
                });
            }
        }

        // Lógica para cargar el resumen del pedido y actualizar contador del carrito
        const orderSummaryItemsContainer = document.getElementById('order-summary-items');
        const summarySubtotalEl = document.getElementById('summary-subtotal');
        const summaryDiscountEl = document.getElementById('summary-discount');
        const summaryTotalEl = document.getElementById('summary-total');
        const cartCountCheckoutEl = document.getElementById('cart-count-checkout');

        function formatPrice(price) {
            return price.toLocaleString('es-CL', { style: 'currency', currency: 'CLP', minimumFractionDigits: 0 });
        }
        
        function getCartItemsForUMD() { // Renombrada para evitar conflicto si se usa en otro lado
            return JSON.parse(localStorage.getItem('christophorosCart')) || [];
        }

        function loadOrderSummary() {
            const cart = getCartItemsForUMD();
            let subtotal = 0;
            let totalItemsInCart = 0;
            
            if (orderSummaryItemsContainer) orderSummaryItemsContainer.innerHTML = ''; 

            if (cart.length === 0) {
                if (orderSummaryItemsContainer) {
                    orderSummaryItemsContainer.innerHTML = '<p class="text-sm text-brand-navy-text/70">Tu carrito está vacío.</p>';
                }
                if (submitButtonGlobal) submitButtonGlobal.disabled = true;
            } else {
                if (submitButtonGlobal) submitButtonGlobal.disabled = false;
                cart.forEach(item => {
                    const itemTotal = item.price * item.quantity;
                    subtotal += itemTotal;
                    totalItemsInCart += item.quantity;

                    if (orderSummaryItemsContainer) {
                        const itemDiv = document.createElement('div');
                        itemDiv.className = 'flex justify-between items-center text-sm';
                        itemDiv.innerHTML = `
                            <div class="flex items-center">
                                <img src="${item.image || 'images/default-product.png'}" alt="${item.name}" class="h-10 w-10 object-contain rounded-md mr-3">
                                <span>${item.name} (x${item.quantity})</span>
                            </div>
                            <span>${formatPrice(itemTotal)}</span>
                        `;
                        orderSummaryItemsContainer.appendChild(itemDiv);
                    }
                });
            }
            
            const total = subtotal - currentDiscountAmount;

            if (summarySubtotalEl) summarySubtotalEl.textContent = formatPrice(subtotal);
            if (summaryDiscountEl) summaryDiscountEl.textContent = `-${formatPrice(currentDiscountAmount)}`;
            if (summaryTotalEl) summaryTotalEl.textContent = formatPrice(total);
            if (cartCountCheckoutEl) cartCountCheckoutEl.textContent = totalItemsInCart;
        }
        
        // Lógica para mostrar/ocultar información de envío
        const infoEnvioSection = document.getElementById('info-envio-section');
        const envioInputs = infoEnvioSection ? Array.from(infoEnvioSection.querySelectorAll('input[type="text"], input[type="tel"], select, textarea')) : [];

        function toggleEnvioInfo(show) {
            if (infoEnvioSection) {
                const isRequired = show; // Los campos de envío son requeridos solo si 'show' es true
                if (show) {
                    infoEnvioSection.style.display = 'block';
                } else {
                    infoEnvioSection.style.display = 'none';
                }
                envioInputs.forEach(input => input.required = isRequired);
            }
        }
        
        const tipoEntregaRadios = document.querySelectorAll('input[name="tipo-entrega"]');
        tipoEntregaRadios.forEach(radio => {
            radio.addEventListener('change', function() {
                toggleEnvioInfo(this.value === 'domicilio');
            });
        });
        
        // Placeholder para el botón de aplicar cupón
        const aplicarCuponBtn = document.getElementById('aplicar-cupon-btn');
        const cuponMessageEl = document.getElementById('cupon-message');

        if(aplicarCuponBtn) {
            aplicarCuponBtn.addEventListener('click', function() {
                const cuponInput = document.getElementById('cupon');
                if (cuponInput && cuponInput.value.trim() !== "") {
                    if (cuponInput.value.toUpperCase() === "DESC10") { // Ejemplo de cupón
                        currentDiscountAmount = 5000; 
                        if(cuponMessageEl) {
                            cuponMessageEl.textContent = `Cupón "${cuponInput.value}" aplicado: ${formatPrice(currentDiscountAmount)} de descuento.`;
                            cuponMessageEl.className = 'text-sm mt-2 text-green-600';
                        }
                    } else {
                        currentDiscountAmount = 0;
                         if(cuponMessageEl) {
                            cuponMessageEl.textContent = "Cupón no válido.";
                            cuponMessageEl.className = 'text-sm mt-2 text-red-600';
                         }
                    }
                    loadOrderSummary(); // Recalcular totales
                } else {
                    if(cuponMessageEl) {
                        cuponMessageEl.textContent = "Por favor, ingresa un código de cupón.";
                        cuponMessageEl.className = 'text-sm mt-2 text-red-600';
                    }
                }
            });
        }

        // --- MÓDULO UMD PARA PEDIDOS ---
        (function (root, factory) {
            if (typeof define === 'function' && define.amd) {
                define([], factory); // No depende de @supabase/supabase-js como módulo AMD, usa el global
            } else if (typeof module === 'object' && module.exports) {
                module.exports = factory(); // No requiere @supabase/supabase-js, usa el global
            } else {
                root.PedidosUMD = factory();
            }
        }(typeof self !== 'undefined' ? self : this, function () {
            'use strict';

            // Esta instancia de supabase se crea usando el objeto global 'supabase' del CDN UMD
            var supabaseClientInstance;
            if (typeof supabase !== 'undefined' && typeof supabase.createClient === 'function') {
                 const SUPABASE_URL_MODULE = 'https://tyqrzixrkrlcklhjvtfu.supabase.co';
                 const SUPABASE_KEY_MODULE = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR5cXJ6aXhya3JsY2tsaGp2dGZ1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDcyMzg2MDYsImV4cCI6MjA2MjgxNDYwNn0.TxhpbioYVXLKH5z4VQfIPzYH7it5c9Qaf-pyI-vWrLo';
                supabaseClientInstance = supabase.createClient(SUPABASE_URL_MODULE, SUPABASE_KEY_MODULE);
                console.log("PedidosUMD: Supabase client instance created within UMD module.");
            } else {
                console.error("PedidosUMD: Global 'supabase' object from UMD CDN not available. Cannot create client instance.");
                supabaseClientInstance = null;
            }

            async function handleSubmit(event) {
                event.preventDefault();
                console.log("PedidosUMD: handleSubmit triggered.");

                const form = event.target;
                const submitButton = document.getElementById('finalizar-compra-btn'); // Usar el ID global

                if (formResponseMessageCheckout) { // Usar la variable global
                    formResponseMessageCheckout.textContent = '';
                    formResponseMessageCheckout.className = 'form-message';
                }
                
                if (submitButton) {
                    submitButton.disabled = true;
                    submitButton.textContent = 'Procesando...';
                }

                // Validación
                let isValid = true;
                const requiredInputs = form.querySelectorAll('[required]');
                requiredInputs.forEach(input => {
                    if (input.offsetWidth > 0 || input.offsetHeight > 0 || input.getClientRects().length > 0) {
                        if (!input.value.trim()) {
                            isValid = false;
                            input.classList.add('border-red-500');
                            console.warn(`PedidosUMD: Campo requerido vacío: ${input.id}`);
                        } else {
                            input.classList.remove('border-red-500');
                        }
                    }
                });
                const terminosCheckbox = document.getElementById('terminos');
                if (!terminosCheckbox.checked) {
                    isValid = false;
                    // alert("Debes aceptar los términos y condiciones."); // Ya no usamos alert
                    if (formResponseMessageCheckout) {
                        formResponseMessageCheckout.textContent = 'Debes aceptar los términos y condiciones.';
                        formResponseMessageCheckout.className = 'form-message error';
                    }
                    console.warn("PedidosUMD: Términos y condiciones no aceptados.");
                }

                if (!isValid) {
                    if (formResponseMessageCheckout && !formResponseMessageCheckout.textContent) { // Solo si no hay ya un mensaje de términos
                        formResponseMessageCheckout.textContent = 'Por favor, completa todos los campos obligatorios (*).';
                        formResponseMessageCheckout.className = 'form-message error';
                    }
                    if (submitButton) {
                        submitButton.disabled = false;
                        submitButton.textContent = 'Finalizar Compra y Realizar Pedido';
                    }
                    return;
                }

                if (!supabaseClientInstance) {
                    console.error('PedidosUMD: Supabase client instance is not available in handleSubmit.');
                    if (formResponseMessageCheckout) {
                        formResponseMessageCheckout.textContent = 'Error crítico: No se pudo conectar con el servicio de pedidos.';
                        formResponseMessageCheckout.className = 'form-message error';
                    }
                    if (submitButton) {
                        submitButton.disabled = false;
                        submitButton.textContent = 'Finalizar Compra y Realizar Pedido';
                    }
                    return;
                }
                
                // Recoger datos del formulario
                const formData = new FormData(form);
                const cartItems = getCartItemsForUMD(); // Usar la función global
                const subtotalCalculado = cartItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                const costoEnvioCalculado = tipoEntrega === 'domicilio' ? (subtotalCalculado >= 50000 ? 0 : 3000) : 0; // Ejemplo, ajustar según tu lógica real
                const totalCalculado = subtotalCalculado + costoEnvioCalculado - currentDiscountAmount; // Usa currentDiscountAmount global

                const tipoEntrega = formData.get('tipo-entrega');

                const pedidoData = {
                    nombre_contacto: formData.get('checkout-nombre'),
                    apellido_contacto: formData.get('checkout-apellido'),
                    email_contacto: formData.get('checkout-email'),
                    telefono_contacto: formData.get('checkout-telefono-contacto'),
                    nombre_boleta: formData.get('boleta-nombre'),
                    rut_boleta: formData.get('boleta-rut'),
                    tipo_entrega: tipoEntrega,
                    nombre_recibe_envio: tipoEntrega === 'domicilio' ? formData.get('envio-nombre-recibe') : null,
                    rut_recibe_envio: tipoEntrega === 'domicilio' ? formData.get('envio-rut-recibe') : null,
                    telefono_recibe_envio: tipoEntrega === 'domicilio' ? formData.get('envio-telefono-recibe') : null,
                    direccion_envio: tipoEntrega === 'domicilio' ? formData.get('envio-direccion') : null,
                    depto_envio: tipoEntrega === 'domicilio' ? formData.get('envio-depto') : null,
                    region_envio: tipoEntrega === 'domicilio' ? formData.get('envio-region') : null,
                    comuna_envio: tipoEntrega === 'domicilio' ? formData.get('envio-comuna') : null,
                    instrucciones_envio: tipoEntrega === 'domicilio' ? formData.get('envio-instrucciones') : null,
                    codigo_cupon: formData.get('cupon') || null,
                    descuento_cupon: currentDiscountAmount,
                    subtotal: subtotalCalculado,
                    costo_envio: costoEnvioCalculado,
                    total: totalCalculado,
                    metodo_pago: formData.get('metodo-pago'),
                    detalles_pago: formData.get('metodo-pago') === 'mercadopago' ? { status: 'pendiente_redireccion' } : null, // Ejemplo
                    items_pedido: cartItems,
                    estado_pedido: 'pendiente'
                };
                console.log("PedidosUMD: Order data to be sent:", pedidoData);

                try {
                    const pedidoRes = await supabaseClientInstance
                        .from('Pedidos') // Nombre de tu tabla de pedidos
                        .insert([pedidoData])
                        .select('id') // Solicitar el ID del pedido insertado
                        .single();

                    if (pedidoRes.error) {
                        console.error('PedidosUMD: Error creando pedido en Supabase:', pedidoRes.error);
                        throw pedidoRes.error; // Lanzar para el catch general
                    }

                    const pedidoId = pedidoRes.data.id;
                    console.log('PedidosUMD: Pedido creado con ID:', pedidoId);

                    // Crear líneas de pedido (opcional si ya guardaste items_pedido como JSON)
                    // Si 'items_pedido' en la tabla 'Pedidos' es de tipo JSONB y guarda el array,
                    // no necesitas una tabla 'lineas_pedido' separada, a menos que lo prefieras por normalización.
                    // Si la necesitas, aquí va la lógica:
                    /*
                    const lineas = cartItems.map(function(item) {
                        return {
                            pedido_id: pedidoId,
                            nombre_producto: item.name, // Asegúrate que 'name' exista en tus items de carrito
                            cantidad: item.quantity,    // Asegúrate que 'quantity' exista
                            precio_unitario: item.price // Asegúrate que 'price' exista
                        };
                    });

                    if (lineas.length > 0) {
                        const lineasRes = await supabaseClientInstance
                            .from('lineas_pedido') // Nombre de tu tabla de líneas de pedido
                            .insert(lineas);

                        if (lineasRes.error) {
                            console.error('PedidosUMD: Error insertando líneas de pedido:', lineasRes.error);
                            // Considera cómo manejar este error parcial (pedido creado pero líneas no)
                        } else {
                            console.log('PedidosUMD: Líneas de pedido insertadas con éxito.');
                        }
                    }
                    */

                    if (formResponseMessageCheckout) {
                        formResponseMessageCheckout.textContent = '¡Pedido realizado con éxito! ID del Pedido: ' + pedidoId;
                        formResponseMessageCheckout.className = 'form-message success';
                    }
                    localStorage.removeItem('christophorosCart');
                    loadOrderSummary(); // Actualizar UI
                    form.reset(); // Resetear formulario
                    toggleEnvioInfo(true); // Resetear visibilidad de envío a domicilio

                } catch (error) {
                    console.error('PedidosUMD: Error en el proceso de envío del pedido:', error);
                    if (formResponseMessageCheckout) {
                        formResponseMessageCheckout.textContent = 'Hubo un error al procesar tu pedido. Por favor, inténtalo de nuevo o contáctanos.';
                        formResponseMessageCheckout.className = 'form-message error';
                    }
                } finally {
                    if (submitButton) {
                        submitButton.disabled = false;
                        submitButton.textContent = 'Finalizar Compra y Realizar Pedido';
                    }
                }
            }

            function init(selectorForm) {
                console.log("PedidosUMD: init called for form:", selectorForm);
                var form = document.querySelector(selectorForm);
                if (form) {
                    form.addEventListener('submit', handleSubmit);
                    console.log("PedidosUMD: Event listener attached to form.");
                } else {
                    console.warn('PedidosUMD: Formulario no encontrado: ' + selectorForm);
                }
            }

            return {
                init: init
            };
        }));

        // INICIALIZAR TODO CUANDO EL DOM ESTÉ LISTO
        document.addEventListener('DOMContentLoaded', () => {
            console.log('checkout.html (DOMContentLoaded): DOM fully loaded. Initializing UMD module.');
            loadOrderSummary(); // Cargar resumen al inicio
            
            // Inicializar la visibilidad de la sección de envío basada en la opción por defecto
            const defaultEntregaRadio = document.querySelector('input[name="tipo-entrega"]:checked');
            if (defaultEntregaRadio) {
                toggleEnvioInfo(defaultEntregaRadio.value === 'domicilio');
            }


            if (window.PedidosUMD && typeof window.PedidosUMD.init === 'function') {
                window.PedidosUMD.init('#checkout-form');
            } else {
                console.error("checkout.html (DOMContentLoaded): PedidosUMD module or its init function is not available at DOMContentLoaded. This might indicate the UMD script itself had an issue or didn't expose PedidosUMD correctly.");
                if (formResponseMessageCheckout) {
                    formResponseMessageCheckout.textContent = 'Error crítico al cargar el sistema de pedidos. Por favor, recarga la página.';
                    formResponseMessageCheckout.className = 'form-message error';
                }
            }
        });
    </script>
</body>
</html>
